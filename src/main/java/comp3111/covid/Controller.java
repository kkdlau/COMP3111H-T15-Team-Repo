package comp3111.covid;

import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.scene.control.Button;
import javafx.scene.control.Tab;
import javafx.scene.control.TextArea;
import javafx.scene.control.TextField;
import javafx.scene.control.ToggleGroup;
import javafx.scene.control.DatePicker;
import javafx.scene.control.Label;
import javafx.scene.control.TableView;
import javafx.scene.control.TableColumn;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.scene.control.cell.MapValueFactory;
import java.util.*;
import java.time.LocalDate;

/**
 * Building on the sample skeleton for 'ui.fxml' Controller Class generated by SceneBuilder 
 */
public class Controller {

    @FXML
    private Tab tabTaskZero;

    @FXML
    private TextField textfieldISO;

    @FXML
    private Button buttonConfirmedDeaths;

    @FXML
    private TextField textfieldDataset;

    @FXML
    private Button buttonRateOfVaccination;

    @FXML
    private Button buttonConfirmedCases;

    @FXML
    private Tab tabReport1;

    @FXML
    private Tab tabReport2;

    @FXML
    private Tab tabReport3;
    
    @FXML
    private DatePicker oneDatePicker;
    @FXML
    private Button buttonRateOfVacTable;
    @FXML
    private Label rateOfVacTableLabel;
    @FXML
    private TextArea textAreaCountryNames;
    @FXML
    private TableView rateOfVacTable;
    @FXML
    private TableColumn vacTableColCountry;
    @FXML
    private TableColumn vacTableColFullyVac;
    @FXML
    private TableColumn vacTableColRateOfVac;
    

    @FXML
    private Tab tabApp1;

    @FXML
    private Tab tabApp2;

    @FXML
    private Tab tabApp3;

    @FXML
    private TextArea textAreaConsole;

    /**
     *  Task Zero
     *  To be triggered by the "Confirmed Cases" button on the Task Zero Tab 
     *  
     */
    @FXML
    void doConfirmedCases(ActionEvent event) {
    	String iDataset = textfieldDataset.getText();
    	String iISO = textfieldISO.getText();
    	String oReport = DataAnalysis.getConfirmedCases(iDataset, iISO);
    	textAreaConsole.setText(oReport);
    }

  
    /**
     *  Task Zero
     *  To be triggered by the "Confirmed Deaths" button on the Task Zero Tab
     *  
     */
    @FXML
    void doConfirmedDeaths(ActionEvent event) {
    	String iDataset = textfieldDataset.getText();
    	String iISO = textfieldISO.getText();
    	String oReport = DataAnalysis.getConfirmedDeaths(iDataset, iISO);
    	textAreaConsole.setText(oReport);
    }

  
    /**
     *  Task Zero
     *  To be triggered by the "Rate of Vaccination" button on the Task Zero Tab
     *  
     */
    @FXML
    void doRateOfVaccination(ActionEvent event) {
    	String iDataset = textfieldDataset.getText();
    	String iISO = textfieldISO.getText();
    	String oReport = DataAnalysis.getRateOfVaccination(iDataset, iISO);
    	textAreaConsole.setText(oReport);
    }  

    /**
     * Table C 
     * To be triggered by "Get Vaccination Rate" button on the Table C tab.
    */
    @FXML
    void doRateOfVacTable(ActionEvent event) {
    	textAreaConsole.setText(""); // clear previous output
    	rateOfVacTable.getItems().clear();
    	
    	String iDataset = textfieldDataset.getText(); // assume dataset specified in Task Zero
    	
    	String iLocations = textAreaCountryNames.getText();
    	if (iLocations.isEmpty()) {
    		textAreaConsole.setText("Please input at least one country of interest!\n");
    		return; 
    	}
    	String errorConsole = "";
    	
    	LocalDate iDate = oneDatePicker.getValue();
    	
    	// parse valid IsoCodes from location
    	List<String> checkLocOutput = CheckInput.checkValidLocations(iLocations, iDataset);
    	
    	if (checkLocOutput.size() == 1) {
    		errorConsole += "Please enter at least one valid country location.\n";
    		textAreaConsole.setText(errorConsole);
    		return;
    	}
    	errorConsole += checkLocOutput.get(checkLocOutput.size() - 1);
    	checkLocOutput.remove(checkLocOutput.size() - 1); // valid IsoCodes
    	
    	String[] validDate = CheckInput.checkValidDate(iDate);
    	errorConsole += validDate[0];
    	
    	textAreaConsole.setText(errorConsole);
    	rateOfVacTableLabel.setText("Rate of Vaccination against COVID-19 as of " + validDate[1]);
    	// pass valid inputs to VaccinationRate methods
    	ObservableList tableData = VaccinationRate.generateVacTable(iDataset, checkLocOutput, validDate[1]);
        vacTableColCountry.setCellValueFactory(new MapValueFactory<>("country"));
        vacTableColFullyVac.setCellValueFactory(new MapValueFactory<>("fully_vaccinated"));
        vacTableColRateOfVac.setCellValueFactory(new MapValueFactory<>("rate_of_vaccination"));
    	
        rateOfVacTable.getItems().addAll(tableData);   	
    }   
}

